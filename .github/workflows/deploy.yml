name: Deploy to Main

on:
  push:
    branches: [main]

permissions:
  id-token: write
  contents: read

jobs:
  build-push:
    runs-on: [self-hosted, dind, arm64]
    steps:
      - uses: actions/checkout@v4
      - name: Auth to GCP
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: projects/${{ secrets.PROJECT_NUMBER }}/locations/global/workloadIdentityPools/github-pool/providers/github-provider
          service_account: ${{ secrets.CI_SA_EMAIL }}
      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2
      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker us-central1-docker.pkg.dev
      - name: Build & Push
        env:
          REGISTRY: ${{ secrets.REGISTRY_URL }}
        run: SHA=$(echo $GITHUB_SHA | cut -c1-8); docker buildx build --no-cache --platform linux/amd64 -t $REGISTRY/app:$SHA -t $REGISTRY/app:main app/; docker push $REGISTRY/app:$SHA; docker push $REGISTRY/app:main
      - name: Install Syft and Trivy
        run: |
          brew install syft trivy
      - name: SBOM
        run: |
          syft ${{ secrets.REGISTRY_URL }}/app:main -o cyclonedx-json > sbom.json
          trivy sbom sbom.json --format json -o trivy-report.json --exit-code 0
      - uses: actions/upload-artifact@v4
        with:
          name: sbom
          path: |
            sbom.json
            trivy-report.json
          
  terraform-apply:
    runs-on: self-hosted
    needs: build-push
    steps:
    - uses: actions/checkout@v4
    - uses: google-github-actions/auth@v2
      with:
        workload_identity_provider: projects/${{ secrets.PROJECT_NUMBER }}/locations/global/workloadIdentityPools/github-pool/providers/github-provider
        service_account: ${{ secrets.CI_SA_EMAIL }}
    - uses: hashicorp/setup-terraform@v3
    - run: terraform -chdir=infra/terraform init
    - run: terraform -chdir=infra/terraform apply -auto-approve

  deploy-dev:
    runs-on: self-hosted
    needs: terraform-apply
    steps:
    - uses: actions/checkout@v4
    - name: short-sha
      uses: benjlevesque/short-sha@v3.0
      id: short-sha
      with:
        length: 8
    - uses: google-github-actions/auth@v2
      with:
        workload_identity_provider: projects/${{ secrets.PROJECT_NUMBER }}/locations/global/workloadIdentityPools/github-pool/providers/github-provider
        service_account: ${{ secrets.CI_SA_EMAIL }}
    - uses: google-github-actions/get-gke-credentials@v2
      with:
        cluster_name: ${{ secrets.CLUSTER_NAME }}
        location: ${{ secrets.CLUSTER_LOCATION }}
    - name: Install Helm (if needed on runner)
      run: curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
    - name: Deploy to Dev
      run: helm upgrade --install app charts/app -f charts/app/values.dev.yaml --set image.tag=${{env.SHA}} --namespace default --create-namespace
    - name: Smoke Test
      run: |
        sleep 30
        for i in {1..10}; do
          SVC_IP=$(kubectl get ingress app -n default -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
          if [ -n "$SVC_IP" ] && [ "$SVC_IP" != "null" ]; then
            echo "Ingress IP ready: $SVC_IP"
            break
          fi
          echo "Waiting for Ingress IP... ($i/10)"
          sleep 30
        done
        if [ -z "$SVC_IP" ] || [ "$SVC_IP" = "null" ]; then
          echo "Ingress IP not ready; falling back to port-forward"
          kubectl port-forward svc/app -n default 8080:80 &
          PORT_FORWARD_PID=$!
          sleep 10
          curl -f http://localhost:8080/healthz || (kill $PORT_FORWARD_PID; exit 1)
          kill $PORT_FORWARD_PID
          exit 0
        fi
        curl -f http://$SVC_IP/healthz || exit 1
        echo "Dev smoke test passed: 200 on /healthz"

  promote-prod:
    runs-on: self-hosted
    needs: deploy-dev
    if: github.event_name == 'push'
    environment: production
    steps:
    - uses: actions/checkout@v4
    - name: short-sha
      uses: benjlevesque/short-sha@v3.0
      id: short-sha
    - uses: google-github-actions/auth@v2
      with:
        workload_identity_provider: projects/${{ secrets.PROJECT_NUMBER }}/locations/global/workloadIdentityPools/github-pool/providers/github-provider
        service_account: ${{ secrets.CI_SA_EMAIL }}
    - uses: google-github-actions/get-gke-credentials@v2
      with:
        cluster_name: ${{ secrets.CLUSTER_NAME }}
        location: ${{ secrets.CLUSTER_LOCATION }}
    - name: Install Helm (if needed)
      run: curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
    - name: Deploy to Prod
      run: helm upgrade --install app charts/app -f charts/app/values.prod.yaml --set image.tag=${{env.SHA}} --namespace ${{ secrets.PROD_NS }} --create-namespace
    - name: Smoke Test Prod
      run: |
        sleep 30
        for i in {1..10}; do
          SVC_IP=$(kubectl get ingress app -n ${{ secrets.PROD_NS }} -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
          if [ -n "$SVC_IP" ] && [ "$SVC_IP" != "null" ]; then
            echo "Ingress IP ready: $SVC_IP"
            break
          fi
          echo "Waiting for Ingress IP... ($i/10)"
          sleep 30
        done
        if [ -z "$SVC_IP" ] || [ "$SVC_IP" = "null" ]; then
          echo "Ingress IP not ready; falling back to port-forward"
          kubectl port-forward svc/app -n ${{ secrets.PROD_NS }} 8080:80 &
          PORT_FORWARD_PID=$!
          sleep 10
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/healthz)
          if [ $STATUS -ne 200 ]; then
            kill $PORT_FORWARD_PID
            helm rollback app -n ${{ secrets.PROD_NS }}
            exit 1
          fi
          kill $PORT_FORWARD_PID
          exit 0
        fi
        STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://$SVC_IP/healthz)
        if [ $STATUS -ne 200 ]; then
          helm rollback app -n ${{ secrets.PROD_NS }}
          exit 1
        fi
        echo "Prod smoke test passed: 200 on /healthz"
    - name: Deployment Summary
      run: 'echo "Deployed image: main, chart: 0.1.0" >> $GITHUB_STEP_SUMMARY'
